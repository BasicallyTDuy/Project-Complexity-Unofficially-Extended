Actor MPistolclip : Ammo
{
  Inventory.Amount 0
  Inventory.MaxAmount 30
  Ammo.BackpackAmount 0
  Ammo.BackpackMaxAmount 30
  Inventory.Icon "CLIPA0"
  +IGNORESKILL
}

Actor MPSpawner
{
	+FLOORCLIP
States
    {
    Spawn:
        TNT1 A 0 Nodelay
            {
                If (ACS_NamedExecuteWithResult("WeaponSwap",1) ==2)
                {
                  A_SpawnItemEx("Pbox", 0,0,0, 0,0,0, 0, SXF_NOCHECKPOSITION | SXF_TRANSFERSPECIAL, 0, tid);
                  }
                Else
                  {
                  A_SpawnItemEx("Justamachinepistol", 0,0,0, 0,0,0, 0, SXF_NOCHECKPOSITION | SXF_TRANSFERSPECIAL, 0, tid);
                  }
            }    
        Stop
    }
}

Actor MapMPSpawner replaces Pistol
{
	+FLOORCLIP
States
    {
    Spawn:
        TNT1 A 0 Nodelay
            {
                If (ACS_NamedExecuteWithResult("WeaponSwap",1) ==2)
                {
                  A_SpawnItemEx("Pbox", 0,0,0, 0,0,0, 0, SXF_NOCHECKPOSITION | SXF_TRANSFERSPECIAL, 0, tid);
                  }
                Else
                  {
                  A_SpawnItemEx("JAMPSpawner", 0,0,0, 0,0,0, 0, SXF_NOCHECKPOSITION | SXF_TRANSFERSPECIAL, 0, tid);
                  }
            }    
        Stop
    }
}


ACTOR Justamachinepistol : JustaWeapon
{
   Weapon.AmmoType1 "MPistolclip"
   Weapon.AmmoUse1 0
   Weapon.AmmoGive1 0
   Weapon.AmmoType2 "bullets"
   Weapon.AmmoUse2 0
   Weapon.AmmoGive2 15
   Weapon.slotnumber 2
   Weapon.SlotPriority 40
   Weapon.SelectionOrder 1700
   Scale 1
    Obituary "%k Was shot 37 times through a door."
    Weapon.UpSound "Weapon/Select"
    Inventory.PickupSound "Pistol/cock"
	Inventory.Pickupmessage "[2] - \c[\Yellow]Machine pistol\c- acquired."
	Inventory.AltHUDIcon "GLOIA0"
	Tag "Brrrrp-Brrrrrrp"
	-weapon.noautofire
	States
	{
		Spawn:
			GLOI A -1
			Stop
		Select:
			GLCM BA 1 A_WeaponReady(WRF_NOFIRE)
			GLCK A 1 A_WeaponReady(WRF_NOFIRE)
			Goto ready
		Deselect:
			GLCK A 1
			GLCM AB 1
			TNT1 A 0 A_lower
			wait
		Ready:
			GLCK A 1 A_WeaponReady(WRF_ALLOWRELOAD|WRF_ALLOWZOOM|WRF_ALLOWUSER1|WRF_ALLOWUSER2)
			Loop
		Dryfire:
			GLCK A 16 A_startsound("Weapons/Pistolempty",11)
			GLCK A 4
			Goto ready
		Fire:
			TNT1 A 0 A_Jumpifinventory("MPistolclip",1,1)
			Goto Dryfire
			TNT1 A 0 
				{
				A_Alertmonsters;
					If(CountInv("Power4xDamage"))
						{
						A_startsound("Weapons/quadfire",5);
						}
					If(CountInv("Chalicedamage"))
						{
						A_startsound("Weapons/quadfire",5);
						}	
				A_startsound("MPistol/fire",10);
				}
			TNT1 A 0 A_Jump(256, "FlashAltB", "FlashAltC")
		FlashAltB:
			GLCK B 1 BRIGHT 
			{
				A_FireBullets (4.4, 4.4, -1, 15, "Pistolpuff", FBF_NORANDOM);
				//A_quake(1,2,0,5, "");
				PC_QuakeCamera(2,1);
			}
			goto FireCont
		FlasAltC:
			GLCK C 1 BRIGHT 
			{
				A_FireBullets (4.4, 4.4, -1, 15, "Pistolpuff", FBF_NORANDOM);
				//A_quake(1,2,0,5, "");
				PC_QuakeCamera(2,1);
			}
		FireCont:
			TNT1 A 0 
				 {
					if(CountInv("Ammotoken") && random(1,5) == 5) 
					{
					A_startsound("ammo/Proc",999,0,0.65);
					}
				else
					{
					A_Takeinventory("MPistolclip",1,TIF_NOTAKEINFINITE);
					}
				}
			TNT1 A 0 
				 {
				  if(CountInv("Guntoken") && random(1,5) == 5)
					{
					A_FireBullets (7.4, 7.4, -1, 15, "Pistolpuff", FBF_NORANDOM);
					A_startsound("Gun/Proc",999,0,1);
					}
				  }
			TNT1 A 0 
				{
				A_FireCustomMissile("PCSpawner",0,0,2,4);
				A_FireCustomMissile("GSSpawner3",0,0,0,8);
				}
			TNT1 A 0 A_ZoomFactor(0.99,ZOOM_INSTANT)
			TNT1 A 0 A_JumpIf(GetCvar("Spooks_Norecoil")==1, "Followthrough")
			TNT1 A 0 PC_WeaponRecoil(1,1)
		  Followthrough:
			GLCK D 1 Offset(0,37)
			GLCK E 1 Offset(0,35) A_ReFire("Fire") 
			TNT1 A 0 A_ZoomFactor(0.999)
			GLCK A 1 Offset(0,34)
			TNT1 A 0 A_ZoomFactor(1.0)
			GLCK A 1 A_WeaponReady(WRF_NOSWITCH|WRF_NOBOB)
			Goto Ready
		Flash:
			TNT1 A 2 A_Light2
			TNT1 A 2 A_Light1
			Goto LightDone
		Reload:
			TNT1 A 0 A_JumpIfInventory("MPistolclip", 30, 2)
			TNT1 A 0 A_JumpIfInventory("bullets", 1, "reloadwork")
			GLCK A 1 
			Goto Ready
		Reloadwork:
			GLCK A 1
			MISR ZYXA 1
			MISR B 1 A_startsound("Pistol/out",10,0)
			MISR CDEF 1
			TNT1 A 0 A_FireCustomMissile("Pclipspawner",0,0,0,-10)
			MISR F 10 
		ReloadLoop:
			TNT1 A 0 A_TakeInventory("bullets", 1)
			TNT1 A 0 A_GiveInventory("MPistolClip", 1) 
			TNT1 A 0 A_JumpIfInventory("MPistolclip", 30, "ReloadFinish") 
			TNT1 A 0 A_JumpIfInventory("bullets", 1, "ReloadLoop")
			Goto ReloadFinish 
		Reloadfinish:
			MISR GH 1
			TNT1 A 0 A_startsound("Pistol/out",10,0)
			MISR IJKL 1		
			MISR MNO 1
			MISR QP 1
			TNT1 A 0 A_startsound("Pistol/cock",8,0)
			GLCK AA 2 
			TNT1 A 0 A_startsound("Pistol/release",8,CHANF_Overlap)
			Goto Ready
		Zoom:
			GLCK A 1
			GLCM AB 1
			Goto Kicking
		User1:
			TNT1 A 0 A_JumpIfInventory("HGammo",1,1)
			Goto Ready
			GLCK A 1
			GLCM AB 1
			Goto nadethrow
		User2:
			TNT1 A 0 A_JumpIfInventory("Mineammo",1,1)
			Goto Ready
			GLCK A 1
			GLCM AB 1
			Goto Minethrow
		Returnstate:
			GLCM BA 1
			GLCK  A 1
			Goto Ready
	}
}